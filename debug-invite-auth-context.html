<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Contexto de Autentica√ß√£o em Convites</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Contexto de Autentica√ß√£o em Convites</h1>
        <p>Este teste verifica especificamente o contexto de autentica√ß√£o durante chamadas RPC de convites familiares.</p>
        
        <div class="section">
            <h3>üìä Estado Atual</h3>
            <div id="authStatus">Verificando...</div>
            <button onclick="checkAuthStatus()" class="btn-primary">Verificar Estado de Autentica√ß√£o</button>
        </div>
        
        <div class="section">
            <h3>üîê Login</h3>
            <input type="email" id="email" placeholder="Email" value="teste2@teste">
            <input type="password" id="password" placeholder="Password" value="123456">
            <button onclick="login()" class="btn-success">Login</button>
            <button onclick="logout()" class="btn-danger">Logout</button>
        </div>
        
        <div class="section">
            <h3>üë• Teste de Convite com Contexto de Auth</h3>
            <input type="email" id="inviteEmail" placeholder="Email do convite" value="debug-test@example.com">
            <select id="inviteRole">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="testInviteWithAuthContext()" class="btn-primary">Testar Convite com Contexto</button>
        </div>
        
        <div class="section">
            <h3>üß™ Teste de Contexto de Sess√£o</h3>
            <button onclick="testSessionContext()" class="btn-primary">Verificar Contexto de Sess√£o</button>
            <button onclick="testRPCWithManualAuth()" class="btn-primary">Testar RPC com Auth Manual</button>
        </div>
        
        <div class="section">
            <h3>üìã Logs</h3>
            <div id="logs" class="log"></div>
            <button onclick="clearLogs()" class="btn-danger">Limpar Logs</button>
        </div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://ztpkpjqmkqfqfqfqfqfq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0cGtwanFta3FmcWZxZnFmcWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEyNDQ2NzQsImV4cCI6MjAzNjgyMDY3NH0.Hs_7dQZKn7TjmNQKWI7VQI7VQI7VQI7VQI7VQI7VQI7VQI';
        
        const supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                flowType: 'pkce'
            }
        });
        
        let currentUser = null;
        let currentSession = null;
        let currentFamily = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function checkAuthStatus() {
            try {
                log('üîç Verificando estado de autentica√ß√£o completo...', 'info');
                
                // Verificar sess√£o
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    log(`‚ùå Erro ao obter sess√£o: ${sessionError.message}`, 'error');
                    return;
                }
                
                currentSession = sessionData.session;
                log(`üìã Sess√£o: ${currentSession ? 'Ativa' : 'Inativa'}`, currentSession ? 'success' : 'warning');
                
                if (currentSession) {
                    log(`üîë Token: ${currentSession.access_token.substring(0, 20)}...`, 'info');
                    log(`‚è∞ Expira em: ${new Date(currentSession.expires_at * 1000).toLocaleString()}`, 'info');
                }
                
                // Verificar utilizador
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userError) {
                    log(`‚ùå Erro ao obter utilizador: ${userError.message}`, 'error');
                    return;
                }
                
                currentUser = userData.user;
                log(`üë§ Utilizador: ${currentUser ? currentUser.email : 'Nenhum'}`, currentUser ? 'success' : 'warning');
                
                if (currentUser) {
                    // Verificar fam√≠lia
                    await loadFamilyData();
                }
                
                updateAuthStatus();
                
            } catch (error) {
                log(`‚ùå Erro inesperado: ${error.message}`, 'error');
            }
        }
        
        async function loadFamilyData() {
            try {
                log('üè† Carregando dados da fam√≠lia...', 'info');
                
                const { data: families, error } = await supabase
                    .from('family_members')
                    .select(`
                        family_id,
                        role,
                        families!inner(id, nome)
                    `)
                    .eq('user_id', currentUser.id)
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Erro ao carregar fam√≠lia: ${error.message}`, 'error');
                    return;
                }
                
                if (families && families.length > 0) {
                    currentFamily = {
                        id: families[0].family_id,
                        name: families[0].families.nome,
                        role: families[0].role
                    };
                    log(`‚úÖ Fam√≠lia carregada: ${currentFamily.name} (${currentFamily.role})`, 'success');
                } else {
                    log('‚ö†Ô∏è Nenhuma fam√≠lia encontrada', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro inesperado ao carregar fam√≠lia: ${error.message}`, 'error');
            }
        }
        
        function updateAuthStatus() {
            const statusDiv = document.getElementById('authStatus');
            let status = '';
            
            if (currentUser && currentSession) {
                status += `<div class="status success">‚úÖ Autenticado: ${currentUser.email}</div>`;
                if (currentFamily) {
                    status += `<div class="status info">üè† Fam√≠lia: ${currentFamily.name} (${currentFamily.role})</div>`;
                } else {
                    status += `<div class="status warning">‚ö†Ô∏è Nenhuma fam√≠lia carregada</div>`;
                }
            } else {
                status += `<div class="status error">‚ùå N√£o autenticado</div>`;
            }
            
            statusDiv.innerHTML = status;
        }
        
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ùå Email e password s√£o obrigat√≥rios', 'error');
                return;
            }
            
            try {
                log(`üîê Tentando login com ${email}...`, 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(`‚ùå Erro no login: ${error.message}`, 'error');
                    return;
                }
                
                log(`‚úÖ Login bem-sucedido: ${data.user.email}`, 'success');
                await checkAuthStatus();
                
            } catch (error) {
                log(`‚ùå Erro inesperado no login: ${error.message}`, 'error');
            }
        };
        
        window.logout = async function() {
            try {
                log('üö™ Fazendo logout...', 'info');
                
                const { error } = await supabase.auth.signOut();
                if (error) {
                    log(`‚ùå Erro no logout: ${error.message}`, 'error');
                    return;
                }
                
                currentUser = null;
                currentSession = null;
                currentFamily = null;
                
                log('‚úÖ Logout bem-sucedido', 'success');
                updateAuthStatus();
                
            } catch (error) {
                log(`‚ùå Erro inesperado no logout: ${error.message}`, 'error');
            }
        };
        
        window.testSessionContext = async function() {
            try {
                log('üß™ Testando contexto de sess√£o...', 'info');
                
                // Verificar m√∫ltiplas formas de obter contexto de auth
                const session1 = await supabase.auth.getSession();
                log(`üìã getSession(): ${session1.data.session ? 'Ativa' : 'Inativa'}`, 'info');
                
                const user1 = await supabase.auth.getUser();
                log(`üë§ getUser(): ${user1.data.user ? user1.data.user.email : 'Nenhum'}`, 'info');
                
                // Verificar se auth.uid() funciona em contexto de RPC
                const { data: authTest, error: authError } = await supabase.rpc('auth_test_function');
                if (authError) {
                    log(`‚ö†Ô∏è Fun√ß√£o de teste de auth n√£o existe (normal): ${authError.message}`, 'warning');
                } else {
                    log(`üîë auth.uid() retorna: ${authTest}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de contexto: ${error.message}`, 'error');
            }
        };
        
        window.testRPCWithManualAuth = async function() {
            if (!currentUser || !currentFamily) {
                log('‚ùå Utilizador ou fam√≠lia n√£o carregados', 'error');
                return;
            }
            
            try {
                log('üß™ Testando RPC com verifica√ß√£o manual de auth...', 'info');
                
                // Primeiro, verificar se o utilizador tem permiss√µes
                const { data: memberCheck, error: memberError } = await supabase
                    .from('family_members')
                    .select('role')
                    .eq('family_id', currentFamily.id)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (memberError) {
                    log(`‚ùå Erro ao verificar membro: ${memberError.message}`, 'error');
                    return;
                }
                
                log(`‚úÖ Verifica√ß√£o de membro: ${memberCheck.role}`, 'success');
                
                if (!['owner', 'admin'].includes(memberCheck.role)) {
                    log(`‚ùå Sem permiss√µes para convidar (role: ${memberCheck.role})`, 'error');
                    return;
                }
                
                // Agora testar a RPC
                const testEmail = 'manual-auth-test@example.com';
                log(`üìß Testando convite para: ${testEmail}`, 'info');
                
                const { data: rpcResult, error: rpcError } = await supabase.rpc('invite_family_member_by_email_safe', {
                    p_family_id: currentFamily.id,
                    p_email: testEmail,
                    p_role: 'member'
                });
                
                if (rpcError) {
                    log(`‚ùå Erro RPC: ${JSON.stringify(rpcError, null, 2)}`, 'error');
                } else {
                    log(`‚úÖ Resultado RPC: ${JSON.stringify(rpcResult, null, 2)}`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro inesperado: ${error.message}`, 'error');
            }
        };
        
        window.testInviteWithAuthContext = async function() {
            if (!currentUser || !currentFamily) {
                log('‚ùå Utilizador ou fam√≠lia n√£o carregados', 'error');
                return;
            }
            
            const email = document.getElementById('inviteEmail').value;
            const role = document.getElementById('inviteRole').value;
            
            if (!email) {
                log('‚ùå Email √© obrigat√≥rio', 'error');
                return;
            }
            
            try {
                log('üß™ Testando convite com contexto de autentica√ß√£o completo...', 'info');
                log(`üìß Email: ${email}, Role: ${role}, Family: ${currentFamily.id}`, 'info');
                
                // Verificar contexto antes da chamada
                const preSession = await supabase.auth.getSession();
                const preUser = await supabase.auth.getUser();
                
                log(`üîç PR√â-RPC - Sess√£o: ${preSession.data.session ? 'Ativa' : 'Inativa'}`, 'info');
                log(`üîç PR√â-RPC - Utilizador: ${preUser.data.user ? preUser.data.user.email : 'Nenhum'}`, 'info');
                
                // Fazer a chamada RPC
                const { data, error } = await supabase.rpc('invite_family_member_by_email_safe', {
                    p_family_id: currentFamily.id,
                    p_email: email,
                    p_role: role
                });
                
                // Verificar contexto ap√≥s a chamada
                const postSession = await supabase.auth.getSession();
                const postUser = await supabase.auth.getUser();
                
                log(`üîç P√ìS-RPC - Sess√£o: ${postSession.data.session ? 'Ativa' : 'Inativa'}`, 'info');
                log(`üîç P√ìS-RPC - Utilizador: ${postUser.data.user ? postUser.data.user.email : 'Nenhum'}`, 'info');
                
                // Verificar se houve mudan√ßa de contexto
                const sessionChanged = preSession.data.session?.access_token !== postSession.data.session?.access_token;
                const userChanged = preUser.data.user?.id !== postUser.data.user?.id;
                
                if (sessionChanged) {
                    log('üö® ALERTA: Sess√£o mudou durante a RPC!', 'error');
                }
                
                if (userChanged) {
                    log('üö® ALERTA: Utilizador mudou durante a RPC!', 'error');
                }
                
                // Processar resultado
                if (error) {
                    log(`‚ùå Erro RPC: ${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    log(`‚úÖ Resultado RPC: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    if (data && data.success) {
                        log('üéâ Convite enviado com sucesso!', 'success');
                    } else if (data && !data.success) {
                        log(`‚ö†Ô∏è Convite falhou: ${data.error} - ${data.message}`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro inesperado: ${error.message}`, 'error');
            }
        };
        
        window.checkAuthStatus = checkAuthStatus;
        window.clearLogs = clearLogs;
        
        // Inicializar
        checkAuthStatus();
    </script>
</body>
</html>