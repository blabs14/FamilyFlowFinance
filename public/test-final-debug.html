<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final - Formul√°rio Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 20px;
        }
        .iframe-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        iframe {
            width: 100%;
            height: 700px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            margin-top: 10px;
        }
        .log-entry {
            margin: 1px 0;
            padding: 2px 4px;
            border-radius: 2px;
            word-wrap: break-word;
        }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-success { background: #d4edda; color: #155724; }
        .log-warning { background: #fff3cd; color: #856404; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-debug { background: #e2e3e5; color: #383d41; }
        h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .test-group {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .test-group h4 {
            margin: 0 0 10px 0;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Final - Formul√°rio de Login</h1>
    
    <div class="container">
        <div class="iframe-container">
            <h3>P√°gina de Login</h3>
            <iframe id="loginFrame" src="/login"></iframe>
        </div>
        
        <div class="controls">
            <h3>Controlos de Debug</h3>
            
            <div class="test-group">
                <h4>üìù Dados de Teste</h4>
                <label for="testEmail">Email:</label>
                <input type="email" id="testEmail" value="teste@exemplo.com">
                
                <label for="testPassword">Password:</label>
                <input type="password" id="testPassword" value="123456">
            </div>
            
            <div class="test-group">
                <h4>üß™ Testes B√°sicos</h4>
                <button onclick="fillAndSubmit()">üöÄ Preencher e Submeter</button>
                <button onclick="checkFormValidation()">‚úÖ Verificar Valida√ß√£o</button>
                <button onclick="monitorAuthState()">üëÅÔ∏è Monitorizar AuthContext</button>
                <button onclick="checkReactHookForm()">üìã Verificar React Hook Form</button>
            </div>
            
            <div class="test-group">
                <h4>üîß Testes Avan√ßados</h4>
                <button onclick="simulateUserFlow()">üë§ Simular Fluxo Utilizador</button>
                <button onclick="checkEventListeners()">üéß Verificar Event Listeners</button>
                <button onclick="inspectButtonState()">üîò Inspecionar Bot√£o</button>
                <button onclick="testFormSubmission()">üì§ Testar Submiss√£o</button>
            </div>
            
            <div class="test-group">
                <h4>üõ†Ô∏è Utilit√°rios</h4>
                <button onclick="reloadPage()">üîÑ Recarregar</button>
                <button onclick="clearLogs()">üßπ Limpar Logs</button>
                <button onclick="exportLogs()">üíæ Exportar Logs</button>
            </div>
            
            <div id="status" class="status warning">Aguardando a√ß√£o...</div>
            
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">Sistema de debug iniciado...</div>
            </div>
        </div>
    </div>

    <script>
        let logCount = 0;
        let monitoringInterval = null;
        
        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (logCount > 150) {
                const firstLog = logContainer.querySelector('.log-entry');
                if (firstLog) firstLog.remove();
                logCount--;
            }
        }
        
        function updateStatus(message, type = 'warning') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function getIframeDocument() {
            const iframe = document.getElementById('loginFrame');
            try {
                return iframe.contentDocument || iframe.contentWindow.document;
            } catch (e) {
                log('‚ùå Erro ao aceder ao iframe: ' + e.message, 'error');
                return null;
            }
        }
        
        function getIframeWindow() {
            const iframe = document.getElementById('loginFrame');
            try {
                return iframe.contentWindow;
            } catch (e) {
                log('‚ùå Erro ao aceder √† window do iframe: ' + e.message, 'error');
                return null;
            }
        }
        
        async function fillAndSubmit() {
            log('üöÄ Iniciando teste completo: preencher e submeter', 'info');
            updateStatus('Executando teste completo...', 'warning');
            
            const doc = getIframeDocument();
            if (!doc) return;
            
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            // 1. Preencher campos
            log('üìù Passo 1: Preenchendo campos...', 'info');
            const emailInput = doc.querySelector('input[type="email"], input[id="email"]');
            const passwordInput = doc.querySelector('input[type="password"], input[id="password"]');
            
            if (!emailInput || !passwordInput) {
                log('‚ùå Campos n√£o encontrados', 'error');
                updateStatus('Erro: Campos n√£o encontrados', 'error');
                return;
            }
            
            emailInput.value = email;
            passwordInput.value = password;
            
            // Disparar eventos
            ['input', 'change', 'blur'].forEach(eventType => {
                emailInput.dispatchEvent(new Event(eventType, { bubbles: true }));
                passwordInput.dispatchEvent(new Event(eventType, { bubbles: true }));
            });
            
            log(`‚úÖ Campos preenchidos: ${email} / ${password}`, 'success');
            
            // 2. Aguardar um pouco para React processar
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 3. Verificar estado do bot√£o
            log('üîò Passo 2: Verificando estado do bot√£o...', 'info');
            const submitButton = doc.querySelector('button[type="submit"]');
            if (submitButton) {
                log(`Bot√£o: disabled=${submitButton.disabled}, text="${submitButton.textContent?.trim()}"`, 'debug');
                
                if (submitButton.disabled) {
                    log('‚ö†Ô∏è Bot√£o est√° desabilitado!', 'warning');
                    updateStatus('Bot√£o desabilitado', 'warning');
                    return;
                }
            }
            
            // 4. Submeter formul√°rio
            log('üì§ Passo 3: Submetendo formul√°rio...', 'info');
            const form = doc.querySelector('form');
            if (form) {
                form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                log('‚úÖ Evento submit disparado', 'success');
                updateStatus('Formul√°rio submetido', 'success');
            } else {
                log('‚ùå Formul√°rio n√£o encontrado', 'error');
                updateStatus('Erro: Formul√°rio n√£o encontrado', 'error');
            }
        }
        
        function checkFormValidation() {
            log('‚úÖ Verificando valida√ß√£o do formul√°rio...', 'info');
            const doc = getIframeDocument();
            if (!doc) return;
            
            const form = doc.querySelector('form');
            const emailInput = doc.querySelector('input[type="email"]');
            const passwordInput = doc.querySelector('input[type="password"]');
            
            if (form && emailInput && passwordInput) {
                log('üìã Estado da valida√ß√£o:', 'debug');
                log(`  - Form v√°lido: ${form.checkValidity()}`, 'debug');
                log(`  - Email v√°lido: ${emailInput.checkValidity()}`, 'debug');
                log(`  - Password v√°lido: ${passwordInput.checkValidity()}`, 'debug');
                log(`  - Email valor: "${emailInput.value}"`, 'debug');
                log(`  - Password valor: "${passwordInput.value}" (length: ${passwordInput.value.length})`, 'debug');
                
                // Verificar mensagens de erro
                const errorElements = doc.querySelectorAll('.text-red-600, .text-red-500, [class*="error"]');
                if (errorElements.length > 0) {
                    log(`‚ö†Ô∏è Encontrados ${errorElements.length} elementos de erro`, 'warning');
                    errorElements.forEach((el, i) => {
                        log(`  Erro ${i+1}: "${el.textContent?.trim()}"`, 'warning');
                    });
                } else {
                    log('‚úÖ Nenhum erro de valida√ß√£o encontrado', 'success');
                }
                
                updateStatus('Valida√ß√£o verificada - ver logs', 'success');
            } else {
                log('‚ùå Elementos do formul√°rio n√£o encontrados', 'error');
                updateStatus('Erro: Elementos n√£o encontrados', 'error');
            }
        }
        
        function monitorAuthState() {
            log('üëÅÔ∏è Iniciando monitoriza√ß√£o do AuthContext...', 'info');
            updateStatus('Monitorizando AuthContext...', 'warning');
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            let lastState = null;
            monitoringInterval = setInterval(() => {
                const win = getIframeWindow();
                if (!win) return;
                
                try {
                    // Tentar aceder ao console do iframe para ver os logs
                    const doc = getIframeDocument();
                    if (doc) {
                        // Procurar pelo elemento de debug que mostra o estado
                        const debugElement = doc.querySelector('.bg-yellow-50');
                        if (debugElement) {
                            const currentState = debugElement.textContent;
                            if (currentState !== lastState) {
                                log(`üîÑ Estado AuthContext: ${currentState.replace(/\s+/g, ' ').trim()}`, 'debug');
                                lastState = currentState;
                            }
                        }
                    }
                } catch (e) {
                    // Ignorar erros de acesso
                }
            }, 1000);
            
            // Parar ap√≥s 30 segundos
            setTimeout(() => {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                    log('‚èπÔ∏è Monitoriza√ß√£o parada', 'info');
                    updateStatus('Monitoriza√ß√£o conclu√≠da', 'success');
                }
            }, 30000);
        }
        
        function checkReactHookForm() {
            log('üìã Verificando React Hook Form...', 'info');
            const doc = getIframeDocument();
            if (!doc) return;
            
            const form = doc.querySelector('form');
            if (form) {
                log('üìù Formul√°rio encontrado', 'success');
                
                // Verificar atributos do formul√°rio
                log(`  - Action: ${form.action || 'n√£o definido'}`, 'debug');
                log(`  - Method: ${form.method || 'n√£o definido'}`, 'debug');
                log(`  - NoValidate: ${form.noValidate}`, 'debug');
                
                // Verificar inputs
                const inputs = form.querySelectorAll('input');
                log(`  - N√∫mero de inputs: ${inputs.length}`, 'debug');
                
                inputs.forEach((input, i) => {
                    log(`  Input ${i+1}: type=${input.type}, name=${input.name || 'sem nome'}, value="${input.value}"`, 'debug');
                });
                
                updateStatus('React Hook Form verificado', 'success');
            } else {
                log('‚ùå Formul√°rio n√£o encontrado', 'error');
                updateStatus('Erro: Formul√°rio n√£o encontrado', 'error');
            }
        }
        
        function simulateUserFlow() {
            log('üë§ Simulando fluxo completo do utilizador...', 'info');
            updateStatus('Simulando fluxo utilizador...', 'warning');
            
            // Simular digita√ß√£o lenta
            setTimeout(() => fillAndSubmit(), 1000);
        }
        
        function checkEventListeners() {
            log('üéß Verificando event listeners...', 'info');
            const doc = getIframeDocument();
            if (!doc) return;
            
            const form = doc.querySelector('form');
            const submitButton = doc.querySelector('button[type="submit"]');
            
            if (form) {
                log('üìã Formul√°rio tem event listeners (n√£o √© poss√≠vel listar)', 'debug');
            }
            
            if (submitButton) {
                log('üîò Bot√£o de submit encontrado', 'debug');
                log(`  - Disabled: ${submitButton.disabled}`, 'debug');
                log(`  - Type: ${submitButton.type}`, 'debug');
                log(`  - Classes: ${submitButton.className}`, 'debug');
            }
            
            updateStatus('Event listeners verificados', 'success');
        }
        
        function inspectButtonState() {
            log('üîò Inspecionando estado detalhado do bot√£o...', 'info');
            const doc = getIframeDocument();
            if (!doc) return;
            
            const submitButton = doc.querySelector('button[type="submit"]');
            if (submitButton) {
                log('üîç Estado detalhado do bot√£o:', 'debug');
                log(`  - Disabled: ${submitButton.disabled}`, 'debug');
                log(`  - Text: "${submitButton.textContent?.trim()}"`, 'debug');
                log(`  - Classes: ${submitButton.className}`, 'debug');
                log(`  - Style: ${submitButton.style.cssText || 'nenhum'}`, 'debug');
                log(`  - TabIndex: ${submitButton.tabIndex}`, 'debug');
                log(`  - Type: ${submitButton.type}`, 'debug');
                
                // Verificar se tem loader
                const loader = submitButton.querySelector('.animate-spin');
                log(`  - Tem loader: ${!!loader}`, 'debug');
                
                updateStatus('Bot√£o inspecionado - ver logs', 'success');
            } else {
                log('‚ùå Bot√£o n√£o encontrado', 'error');
                updateStatus('Erro: Bot√£o n√£o encontrado', 'error');
            }
        }
        
        function testFormSubmission() {
            log('üì§ Testando submiss√£o do formul√°rio...', 'info');
            const doc = getIframeDocument();
            if (!doc) return;
            
            const form = doc.querySelector('form');
            if (form) {
                // Adicionar listener tempor√°rio
                const handleSubmit = (e) => {
                    log('üéØ Evento submit capturado!', 'success');
                    log(`  - Prevented: ${e.defaultPrevented}`, 'debug');
                    log(`  - Target: ${e.target.tagName}`, 'debug');
                    form.removeEventListener('submit', handleSubmit);
                };
                
                form.addEventListener('submit', handleSubmit);
                
                // Disparar submit
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
                
                updateStatus('Teste de submiss√£o executado', 'success');
            } else {
                log('‚ùå Formul√°rio n√£o encontrado', 'error');
                updateStatus('Erro: Formul√°rio n√£o encontrado', 'error');
            }
        }
        
        function reloadPage() {
            log('üîÑ Recarregando p√°gina...', 'info');
            const iframe = document.getElementById('loginFrame');
            iframe.src = iframe.src;
            updateStatus('P√°gina recarregada', 'success');
        }
        
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry log-info">Logs limpos. Sistema pronto.</div>';
            logCount = 1;
            updateStatus('Logs limpos', 'success');
        }
        
        function exportLogs() {
            const logs = document.getElementById('logContainer').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-logs-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('üíæ Logs exportados', 'success');
            updateStatus('Logs exportados', 'success');
        }
        
        // Monitorizar carregamento do iframe
        document.getElementById('loginFrame').addEventListener('load', function() {
            log('üîÑ Iframe carregado', 'success');
            updateStatus('P√°gina carregada', 'success');
        });
        
        // Log inicial
        log('üöÄ Sistema de debug final iniciado', 'success');
        log('üìã Use os controlos para diagnosticar o problema do formul√°rio', 'info');
    </script>
</body>
</html>