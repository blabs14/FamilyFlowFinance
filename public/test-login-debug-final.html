<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final - Login Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .logs {
            height: 400px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }
        .log-debug { color: #8b5cf6; }
        
        .timestamp {
            color: #6b7280;
            font-size: 10px;
        }
        
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Final - Teste de Login</h1>
    
    <div class="container">
        <div class="panel">
            <h3>üéÆ Controlos de Teste</h3>
            <div class="controls">
                <div class="form-group">
                    <label>Email de Teste:</label>
                    <input type="email" id="testEmail" value="testetotal@teste.com" placeholder="Email para teste">
                </div>
                
                <div class="form-group">
                    <label>Password de Teste:</label>
                    <input type="password" id="testPassword" value="123456" placeholder="Password para teste">
                </div>
                
                <button class="btn-primary" onclick="fillAndSubmitForm()">üöÄ Preencher e Submeter</button>
                <button class="btn-secondary" onclick="checkFormValidation()">‚úÖ Verificar Valida√ß√£o</button>
                <button class="btn-success" onclick="simulateDirectLogin()">üîê Teste Login Direto</button>
                <button class="btn-warning" onclick="inspectFormState()">üîç Inspecionar Estado</button>
                <button class="btn-danger" onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
                
                <hr>
                
                <button class="btn-secondary" onclick="reloadIframe()">üîÑ Recarregar P√°gina</button>
                <button class="btn-warning" onclick="openDevTools()">üõ†Ô∏è Abrir DevTools</button>
            </div>
        </div>
        
        <div class="panel">
            <h3>üì± Aplica√ß√£o</h3>
            <iframe id="appFrame" src="http://localhost:8082/login"></iframe>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h3>üìã Logs de Debug</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            logCount++;
            
            if (logCount > 100) {
                logsDiv.removeChild(logsDiv.firstChild);
                logCount--;
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            logCount = 0;
            log('Logs limpos', 'info');
        }
        
        function reloadIframe() {
            const iframe = document.getElementById('appFrame');
            iframe.src = iframe.src;
            log('P√°gina recarregada', 'info');
        }
        
        function openDevTools() {
            log('Para abrir DevTools: F12 ou Ctrl+Shift+I', 'info');
        }
        
        function getIframeDocument() {
            const iframe = document.getElementById('appFrame');
            try {
                return iframe.contentDocument || iframe.contentWindow.document;
            } catch (e) {
                log('‚ùå Erro ao aceder ao iframe: ' + e.message, 'error');
                return null;
            }
        }
        
        function fillAndSubmitForm() {
            log('üöÄ Iniciando preenchimento e submiss√£o do formul√°rio...', 'info');
            
            const doc = getIframeDocument();
            if (!doc) return;
            
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            // Encontrar campos do formul√°rio
            const emailField = doc.querySelector('input[type="email"], input[name="email"], #email');
            const passwordField = doc.querySelector('input[type="password"], input[name="password"], #password');
            const submitButton = doc.querySelector('button[type="submit"], button:contains("Entrar"), .login-button');
            
            if (!emailField || !passwordField) {
                log('‚ùå Campos de email ou password n√£o encontrados', 'error');
                return;
            }
            
            log(`üìù Preenchendo email: ${email}`, 'info');
            emailField.value = email;
            emailField.dispatchEvent(new Event('input', { bubbles: true }));
            emailField.dispatchEvent(new Event('change', { bubbles: true }));
            
            log(`üîí Preenchendo password: ${'*'.repeat(password.length)}`, 'info');
            passwordField.value = password;
            passwordField.dispatchEvent(new Event('input', { bubbles: true }));
            passwordField.dispatchEvent(new Event('change', { bubbles: true }));
            
            // Aguardar um pouco para a valida√ß√£o
            setTimeout(() => {
                if (submitButton) {
                    log(`üéØ Bot√£o encontrado: ${submitButton.textContent.trim()}`, 'info');
                    log(`üîç Bot√£o desabilitado: ${submitButton.disabled}`, submitButton.disabled ? 'warning' : 'success');
                    
                    if (submitButton.disabled) {
                        log('‚ö†Ô∏è Bot√£o est√° desabilitado! Verificando raz√µes...', 'warning');
                        inspectFormState();
                    } else {
                        log('‚úÖ Clicando no bot√£o de submit...', 'success');
                        submitButton.click();
                        
                        // Monitorizar mudan√ßas ap√≥s o clique
                        setTimeout(() => {
                            log('üìä Verificando estado ap√≥s clique...', 'info');
                            inspectFormState();
                        }, 1000);
                    }
                } else {
                    log('‚ùå Bot√£o de submit n√£o encontrado', 'error');
                }
            }, 500);
        }
        
        function checkFormValidation() {
            log('‚úÖ Verificando valida√ß√£o do formul√°rio...', 'info');
            
            const doc = getIframeDocument();
            if (!doc) return;
            
            const form = doc.querySelector('form');
            const emailField = doc.querySelector('input[type="email"], input[name="email"], #email');
            const passwordField = doc.querySelector('input[type="password"], input[name="password"], #password');
            
            if (form) {
                log(`üìã Formul√°rio v√°lido: ${form.checkValidity()}`, form.checkValidity() ? 'success' : 'error');
            }
            
            if (emailField) {
                log(`üìß Email v√°lido: ${emailField.checkValidity()} (valor: ${emailField.value})`, emailField.checkValidity() ? 'success' : 'error');
                if (!emailField.checkValidity()) {
                    log(`‚ùå Erro de valida√ß√£o do email: ${emailField.validationMessage}`, 'error');
                }
            }
            
            if (passwordField) {
                log(`üîí Password v√°lida: ${passwordField.checkValidity()} (comprimento: ${passwordField.value.length})`, passwordField.checkValidity() ? 'success' : 'error');
                if (!passwordField.checkValidity()) {
                    log(`‚ùå Erro de valida√ß√£o da password: ${passwordField.validationMessage}`, 'error');
                }
            }
        }
        
        function simulateDirectLogin() {
            log('üîê Simulando login direto via Supabase...', 'info');
            
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            // Tentar aceder ao Supabase atrav√©s do iframe
            const iframe = document.getElementById('appFrame');
            try {
                const iframeWindow = iframe.contentWindow;
                if (iframeWindow && iframeWindow.supabase) {
                    log('üéØ Cliente Supabase encontrado no iframe', 'success');
                    
                    iframeWindow.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    }).then(result => {
                        if (result.error) {
                            log(`‚ùå Erro no login: ${result.error.message}`, 'error');
                        } else {
                            log('‚úÖ Login direto bem-sucedido!', 'success');
                            log(`üë§ Utilizador: ${result.data.user?.email}`, 'info');
                        }
                    }).catch(error => {
                        log(`‚ùå Erro na chamada: ${error.message}`, 'error');
                    });
                } else {
                    log('‚ùå Cliente Supabase n√£o encontrado no iframe', 'error');
                }
            } catch (e) {
                log(`‚ùå Erro ao aceder ao Supabase: ${e.message}`, 'error');
            }
        }
        
        function inspectFormState() {
            log('üîç Inspecionando estado completo do formul√°rio...', 'debug');
            
            const doc = getIframeDocument();
            if (!doc) return;
            
            // Verificar todos os elementos relevantes
            const form = doc.querySelector('form');
            const emailField = doc.querySelector('input[type="email"], input[name="email"], #email');
            const passwordField = doc.querySelector('input[type="password"], input[name="password"], #password');
            const submitButton = doc.querySelector('button[type="submit"], button:contains("Entrar"), .login-button');
            const allButtons = doc.querySelectorAll('button');
            
            log('üìä === ESTADO DO FORMUL√ÅRIO ===', 'debug');
            
            if (form) {
                log(`üìã Formul√°rio encontrado: ${form.tagName}`, 'debug');
                log(`üìã Classes do formul√°rio: ${form.className}`, 'debug');
            }
            
            if (emailField) {
                log(`üìß Campo email: valor="${emailField.value}", v√°lido=${emailField.checkValidity()}`, 'debug');
            }
            
            if (passwordField) {
                log(`üîí Campo password: comprimento=${passwordField.value.length}, v√°lido=${passwordField.checkValidity()}`, 'debug');
            }
            
            log(`üéØ Bot√µes encontrados: ${allButtons.length}`, 'debug');
            allButtons.forEach((btn, index) => {
                log(`üéØ Bot√£o ${index + 1}: "${btn.textContent.trim()}" (desabilitado: ${btn.disabled}, tipo: ${btn.type})`, 'debug');
            });
            
            // Verificar estados de loading/submitting
            const loadingElements = doc.querySelectorAll('[data-loading], .loading, .submitting');
            if (loadingElements.length > 0) {
                log(`‚è≥ Elementos em loading encontrados: ${loadingElements.length}`, 'warning');
            }
            
            // Verificar erros vis√≠veis
            const errorElements = doc.querySelectorAll('.error, .alert-error, [role="alert"]');
            if (errorElements.length > 0) {
                log(`‚ùå Elementos de erro encontrados: ${errorElements.length}`, 'error');
                errorElements.forEach((el, index) => {
                    log(`‚ùå Erro ${index + 1}: ${el.textContent.trim()}`, 'error');
                });
            }
        }
        
        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üé¨ Teste de debug carregado', 'success');
            log('üìã Instru√ß√µes:', 'info');
            log('1. Clique em "Preencher e Submeter" para testar o fluxo completo', 'info');
            log('2. Use "Verificar Valida√ß√£o" para verificar se os campos est√£o v√°lidos', 'info');
            log('3. "Teste Login Direto" testa a API do Supabase diretamente', 'info');
            log('4. "Inspecionar Estado" mostra detalhes do formul√°rio', 'info');
        });
    </script>
</body>
</html>